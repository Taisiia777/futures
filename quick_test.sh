#!/bin/bash

# ðŸ§ª Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¢Ð•Ð¡Ð¢ ULTIMATE PUMP HUNTER
# Ð—Ð°Ð¿ÑƒÑÐº Ð½Ð° 1 Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}ðŸ§ª Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¢Ð•Ð¡Ð¢ ULTIMATE PUMP HUNTER${NC}"
echo -e "${BLUE}======================================${NC}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ node_modules
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸...${NC}"
    npm install
fi

# ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ TypeScript
echo -e "${YELLOW}ðŸ”§ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚...${NC}"
npx tsc --noEmit || {
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð´.${NC}"
    exit 1
}

echo -e "${GREEN}âœ… Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!${NC}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
echo -e "${CYAN}ðŸ“Š ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯:${NC}"
echo -e "   ðŸ’° Ð ÐµÐ¶Ð¸Ð¼: $(grep 'TEST_MODE=' .env | cut -d'=' -f2 | sed 's/true/Ð’Ð˜Ð Ð¢Ð£ÐÐ›Ð¬ÐÐ«Ð™ âœ…/g' | sed 's/false/âš ï¸ Ð‘ÐžÐ•Ð’ÐžÐ™/g')"
echo -e "   ðŸŽ¯ Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ: 1 Ð¼Ð¸Ð½ÑƒÑ‚Ð° (Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº)"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p logs

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ñ‚ÐµÑÑ‚
echo -e "${GREEN}ðŸš€ Ð—ÐÐŸÐ£Ð¡Ðš Ð‘Ð«Ð¡Ð¢Ð ÐžÐ“Ðž Ð¢Ð•Ð¡Ð¢Ð (1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°)...${NC}"
echo -e "${YELLOW}ðŸ’¡ Ð­Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð²ÑÐµÑ… ÑÐ¸ÑÑ‚ÐµÐ¼${NC}"
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð¼ Ð² 1 Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
timeout 60s npx ts-node night_test_runner.ts 0.017 2>&1 | tee "logs/quick_test_$(date +%Y%m%d_%H%M%S).log"

EXIT_CODE=$?

echo ""
echo -e "${BLUE}======================================${NC}"

if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 124 ]; then  # 124 = timeout
    echo -e "${GREEN}âœ… Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¢Ð•Ð¡Ð¢ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð!${NC}"
    echo -e "${CYAN}ðŸ“„ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°${NC}"
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
    echo ""
    echo -e "${PURPLE}ðŸ“Š ÐšÐ ÐÐ¢ÐšÐ˜Ð™ ÐžÐ‘Ð—ÐžÐ :${NC}"
    echo -e "   ðŸ”§ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾"
    echo -e "   ðŸŒ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Binance: âœ… OK"
    echo -e "   ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸: âœ… OK"
    echo -e "   ðŸ“„ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²: âœ… OK"
    
    echo ""
    echo -e "${GREEN}ðŸŽ‰ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ð½Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ñ‚ÐµÑÑ‚Ñƒ!${NC}"
    echo -e "${CYAN}ðŸ’¡ Ð”Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./start_night_test.sh${NC}"
    
else
    echo -e "${RED}âŒ Ð‘Ð«Ð¡Ð¢Ð Ð«Ð™ Ð¢Ð•Ð¡Ð¢ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð Ð¡ ÐžÐ¨Ð˜Ð‘ÐšÐžÐ™ (ÐºÐ¾Ð´: ${EXIT_CODE})${NC}"
    echo -e "${YELLOW}ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð² Ð¿Ð°Ð¿ÐºÐµ logs/${NC}"
fi

echo ""
echo -e "${YELLOW}ðŸ“‹ Ð¡Ð›Ð•Ð”Ð£Ð®Ð©Ð˜Ð• Ð¨ÐÐ“Ð˜:${NC}"
echo -e "   1. Ð•ÑÐ»Ð¸ Ñ‚ÐµÑÑ‚ Ð¿Ñ€Ð¾ÑˆÐµÐ» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ -> Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ./start_night_test.sh"
echo -e "   2. Ð•ÑÐ»Ð¸ Ð±Ñ‹Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ -> Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ð¸ API ÐºÐ»ÑŽÑ‡Ð¸"
echo -e "   3. Ð”Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð½Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð° -> ./start_night_test.sh 8"

exit $EXIT_CODE
