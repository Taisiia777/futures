#!/bin/bash

# üåô –°–ö–†–ò–ü–¢ –ó–ê–ü–£–°–ö–ê –ù–û–ß–ù–û–ì–û –¢–ï–°–¢–ê ULTIMATE PUMP HUNTER
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start_night_test.sh [—á–∞—Å—ã]
# –ü—Ä–∏–º–µ—Ä: ./start_night_test.sh 8  (–∑–∞–ø—É—Å–∫ –Ω–∞ 8 —á–∞—Å–æ–≤)

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}üåô ULTIMATE PUMP HUNTER - –ù–û–ß–ù–û–ô –¢–ï–°–¢${NC}"
echo -e "${BLUE}===============================================${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
HOURS=${1:-8}  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 8 —á–∞—Å–æ–≤
echo -e "${CYAN}‚è±Ô∏è  –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞: ${HOURS} —á–∞—Å–æ–≤${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ node_modules
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
    npm install
fi

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º TypeScript
echo -e "${YELLOW}üîß –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç...${NC}"
npx tsc --noEmit || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥.${NC}"
    exit 1
}

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="logs/night_test_${TIMESTAMP}.log"

echo -e "${GREEN}‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!${NC}"
echo -e "${CYAN}üìù –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã –≤: ${LOG_FILE}${NC}"
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ—á–Ω–æ–π —Ç–µ—Å—Ç...${NC}"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo -e "${BLUE}üìä –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–ï–°–¢–ê:${NC}"
echo -e "   üí∞ –ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: 100 USDT"
echo -e "   üéØ –†–µ–∂–∏–º: $(grep 'TEST_MODE=' .env | cut -d'=' -f2 | sed 's/true/–í–ò–†–¢–£–ê–õ–¨–ù–´–ô/g' | sed 's/false/–ë–û–ï–í–û–ô/g')"
echo -e "   üïê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${HOURS} —á–∞—Å–æ–≤"
echo -e "   üìÅ –õ–æ–≥ —Ñ–∞–π–ª: ${LOG_FILE}"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ—á–Ω–æ–π —Ç–µ—Å—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
echo -e "${GREEN}üåô –ó–ê–ü–£–°–ö –ù–û–ß–ù–û–ì–û –¢–ï–°–¢–ê...${NC}"
npx ts-node night_test_runner.ts ${HOURS} 2>&1 | tee "${LOG_FILE}"

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
EXIT_CODE=$?

echo ""
echo -e "${BLUE}===============================================${NC}"

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ù–û–ß–ù–û–ô –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!${NC}"
    echo -e "${CYAN}üìÑ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    echo -e "${YELLOW}üìù –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${LOG_FILE}${NC}"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–∑–æ—Ä–∞
    echo ""
    echo -e "${PURPLE}üìä –ö–†–ê–¢–ö–ò–ô –û–ë–ó–û–† –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:${NC}"
    tail -20 "${LOG_FILE}" | grep -E "(–ö–∞–ø–∏—Ç–∞–ª|WinRate|—Ä–æ—Å—Ç|–§–∏–Ω–∞–ª—å–Ω—ã–π|–¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù)"
    
else
    echo -e "${RED}‚ùå –ù–û–ß–ù–û–ô –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –° –û–®–ò–ë–ö–û–ô (–∫–æ–¥: ${EXIT_CODE})${NC}"
    echo -e "${YELLOW}üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: ${LOG_FILE}${NC}"
fi

echo ""
echo -e "${CYAN}üîç –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:${NC}"
echo -e "   üìÑ –û—Ç–∫—Ä–æ–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç night_test_report_*.md"
echo -e "   üìù –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏: cat ${LOG_FILE}"
echo -e "   üìä –ù–∞–π–¥–∏—Ç–µ —Ñ–∞–π–ª—ã –æ—Ç—á–µ—Ç–æ–≤: ls -la night_test_report_*.md"

exit $EXIT_CODE
