#!/bin/bash

# üîß –¢–ï–°–¢ –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò –ö –°–ï–¢–ï–í–´–ú –û–®–ò–ë–ö–ê–ú
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∫ –±–æ—Ç —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Binance

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}üîß –¢–ï–°–¢ –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò –ö –°–ï–¢–ï–í–´–ú –û–®–ò–ë–ö–ê–ú${NC}"
echo -e "${BLUE}===========================================${NC}"

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç
echo -e "${YELLOW}üîß –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç...${NC}"
npx tsc --noEmit || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏!${NC}"
    exit 1
}

echo -e "${GREEN}‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞${NC}"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –Ω–∞ 2 –º–∏–Ω—É—Ç—ã
echo -e "${CYAN}üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:${NC}"
echo -e "   üîÑ –ë—É–¥–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å retry-–º–µ—Ö–∞–Ω–∏–∑–º—ã"
echo -e "   üåê –ü—Ä–æ–≤–µ—Ä–∏—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–µ—Ç–µ–≤—ã–º –æ—à–∏–±–∫–∞–º"
echo -e "   ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 –º–∏–Ω—É—Ç—ã"
echo ""

LOG_FILE="logs/network_resilience_test_$(date +%Y%m%d_%H%M%S).log"

echo -e "${GREEN}üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê...${NC}"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –Ω–∞ 2 –º–∏–Ω—É—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º gtimeout –¥–ª—è macOS –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
if command -v gtimeout &> /dev/null; then
    # –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω gtimeout (brew install coreutils)
    gtimeout 120s npx ts-node night_test_runner.ts 0.033 2>&1 | tee "$LOG_FILE"
    EXIT_CODE=$?
elif command -v timeout &> /dev/null; then
    # –ï—Å–ª–∏ –µ—Å—Ç—å timeout (Linux)
    timeout 120s npx ts-node night_test_runner.ts 0.033 2>&1 | tee "$LOG_FILE"
    EXIT_CODE=$?
else
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è macOS –±–µ–∑ coreutils
    echo -e "${YELLOW}‚ö†Ô∏è timeout –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏...${NC}"
    echo -e "${CYAN}üí° –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã –Ω–∞–∂–∞–≤ Ctrl+C${NC}"
    npx ts-node night_test_runner.ts 0.033 2>&1 | tee "$LOG_FILE" &
    TEST_PID=$!
    
    # –ñ–¥–µ–º 120 —Å–µ–∫—É–Ω–¥
    sleep 120
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    kill -TERM $TEST_PID 2>/dev/null
    wait $TEST_PID 2>/dev/null
    EXIT_CODE=$?
fi

echo ""
echo -e "${BLUE}===========================================${NC}"

if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 124 ]; then  # 124 = timeout
    echo -e "${GREEN}‚úÖ –¢–ï–°–¢ –£–°–¢–û–ô–ß–ò–í–û–°–¢–ò –ó–ê–í–ï–†–®–ï–ù${NC}"
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    echo ""
    echo -e "${PURPLE}üìä –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:${NC}"
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
    NETWORK_ERRORS=$(grep -c "–í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞\|üåê –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞\|üîÑ –ü–æ–ø—ã—Ç–∫–∞" "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    RECOVERED_CONNECTIONS=$(grep -c "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ" "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    CRITICAL_ERRORS=$(grep -c "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞" "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    
    echo -e "   üåê –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏: ${NETWORK_ERRORS}"
    echo -e "   ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${RECOVERED_CONNECTIONS}"  
    echo -e "   ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏: ${CRITICAL_ERRORS}"
    
    if [ "$CRITICAL_ERRORS" -eq 0 ]; then
        echo -e "${GREEN}‚ú® –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨ –ö –°–ï–¢–ï–í–´–ú –û–®–ò–ë–ö–ê–ú: –û–¢–õ–ò–ß–ù–û${NC}"
        echo -e "   –ë–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã"
    elif [ "$CRITICAL_ERRORS" -lt 5 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨: –•–û–†–û–®–û${NC}"
        echo -e "   –ï—Å—Ç—å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"
    else
        echo -e "${RED}‚ùå –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨: –¢–†–ï–ë–£–ï–¢ –î–û–†–ê–ë–û–¢–ö–ò${NC}"
        echo -e "   –ú–Ω–æ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞
    BOT_ACTIVITY=$(grep -c "‚ö° \[" "$LOG_FILE" 2>/dev/null | tr -d '\n' || echo "0")
    if [ "$BOT_ACTIVITY" -gt 5 ]; then
        echo -e "${GREEN}‚úÖ –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ë–û–¢–ê: –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è –ê–ö–¢–ò–í–ù–û–°–¢–¨ –ë–û–¢–ê: –ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å${NC}"
    fi
    
else
    echo -e "${RED}‚ùå –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –° –û–®–ò–ë–ö–û–ô (–∫–æ–¥: ${EXIT_CODE})${NC}"
fi

echo ""
echo -e "${CYAN}üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏: ${LOG_FILE}${NC}"
echo -e "${YELLOW}üí° –î–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: ./start_night_test.sh${NC}"

exit $EXIT_CODE
