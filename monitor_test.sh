#!/bin/bash

# üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ù–û–ß–ù–û–ì–û –¢–ï–°–¢–ê ULTIMATE PUMP HUNTER
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Å—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

clear

echo -e "${PURPLE}üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì ULTIMATE PUMP HUNTER${NC}"
echo -e "${BLUE}=====================================${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω –ª–∏ —Ç–µ—Å—Ç
if ! pgrep -f "night_test_runner.ts" > /dev/null; then
    echo -e "${RED}‚ùå –ù–æ—á–Ω–æ–π —Ç–µ—Å—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
    echo -e "${YELLOW}üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –∫–æ–º–∞–Ω–¥–æ–π: ./start_night_test.sh${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –ù–æ—á–Ω–æ–π —Ç–µ—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω${NC}"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ –ª–æ–≥–æ–≤
show_current_stats() {
    # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–æ–≥ —Ñ–∞–π–ª
    LATEST_LOG=$(ls -t logs/night_test_*.log 2>/dev/null | head -1)
    
    if [ -z "$LATEST_LOG" ]; then
        echo -e "${RED}‚ùå –õ–æ–≥ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
        return
    fi
    
    echo -e "${CYAN}üìÑ –¢–µ–∫—É—â–∏–π –ª–æ–≥: ${LATEST_LOG}${NC}"
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    echo -e "${YELLOW}‚ö° –ü–û–°–õ–ï–î–ù–ò–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø:${NC}"
    tail -50 "$LATEST_LOG" | grep -E "‚ö° \[" | tail -3
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    echo -e "${BLUE}üìä –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:${NC}"
    tail -200 "$LATEST_LOG" | grep -A 10 "–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê" | tail -11
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    echo -e "${GREEN}üéØ –ü–û–°–õ–ï–î–ù–ò–ï –°–î–ï–õ–ö–ò:${NC}"
    tail -100 "$LATEST_LOG" | grep -E "(–û–¢–ö–†–´–í–ê–ï–ú –ü–û–ó–ò–¶–ò–Æ|–ó–ê–ö–†–´–í–ê–ï–ú –ü–û–ó–ò–¶–ò–Æ|PROFIT|LOSS)" | tail -5
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã
    echo -e "${PURPLE}‚öôÔ∏è –ê–ö–¢–ò–í–ù–´–ï –†–ï–ñ–ò–ú–´:${NC}"
    tail -50 "$LATEST_LOG" | grep -E "(–°–õ–û–ñ–ù–´–ô –ü–†–û–¶–ï–ù–¢|–ö–û–ù–°–ï–†–í–ê–¢–ò–í–ù–´–ô –†–ï–ñ–ò–ú|–ê–ö–¢–ò–í–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø)" | tail -3
    echo ""
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
monitor_test() {
    while true; do
        clear
        echo -e "${PURPLE}üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì ULTIMATE PUMP HUNTER${NC}"
        echo -e "${BLUE}=====================================${NC}"
        echo -e "${CYAN}üïê –û–±–Ω–æ–≤–ª–µ–Ω–æ: $(date '+%H:%M:%S')${NC}"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ—Å—Ç –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω
        if ! pgrep -f "night_test_runner.ts" > /dev/null; then
            echo -e "${RED}‚ùå –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
            echo ""
            echo -e "${YELLOW}üìÑ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—á–µ—Ç—ã:${NC}"
            ls -la night_test_report_*.md 2>/dev/null || echo "   –û—Ç—á–µ—Ç—ã –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã"
            break
        fi
        
        show_current_stats
        
        echo -e "${CYAN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
        echo -e "${YELLOW}–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥... (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)${NC}"
        
        sleep 30
    done
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
case "${1}" in
    "stats"|"s")
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–¥–∏–Ω —Ä–∞–∑ –∏ –≤—ã–π—Ç–∏
        show_current_stats
        ;;
    "logs"|"l")
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ö–≤–æ—Å—Ç –ª–æ–≥–æ–≤
        LATEST_LOG=$(ls -t logs/night_test_*.log 2>/dev/null | head -1)
        if [ -n "$LATEST_LOG" ]; then
            echo -e "${CYAN}üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ${LATEST_LOG}${NC}"
            echo -e "${YELLOW}(Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)${NC}"
            echo ""
            tail -f "$LATEST_LOG"
        else
            echo -e "${RED}‚ùå –õ–æ–≥ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã${NC}"
        fi
        ;;
    "help"|"h"|"-h"|"--help")
        echo -e "${CYAN}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:${NC}"
        echo "  ./monitor_test.sh        - –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
        echo "  ./monitor_test.sh stats  - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–¥–∏–Ω —Ä–∞–∑"
        echo "  ./monitor_test.sh logs   - –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
        echo "  ./monitor_test.sh help   - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
        ;;
    *)
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        monitor_test
        ;;
esac
