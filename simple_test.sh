#!/bin/bash

# üß™ –ü–†–û–°–¢–û–ô –¢–ï–°–¢ RETRY-–ú–ï–•–ê–ù–ò–ó–ú–û–í
# –¢–µ—Å—Ç –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è timeout –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å macOS

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}üß™ –ü–†–û–°–¢–û–ô –¢–ï–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô${NC}"
echo -e "${BLUE}==============================${NC}"

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç
echo -e "${YELLOW}üîß –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç...${NC}"
npx tsc --noEmit || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏!${NC}"
    exit 1
}

echo -e "${GREEN}‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞${NC}"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

LOG_FILE="logs/simple_test_$(date +%Y%m%d_%H%M%S).log"

echo -e "${CYAN}üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï RETRY-–ú–ï–•–ê–ù–ò–ó–ú–û–í:${NC}"
echo -e "   üîÑ –ü—Ä–æ–≤–µ—Ä–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫"
echo -e "   üåê –¢–µ—Å—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ API –ø—Ä–æ–±–ª–µ–º–∞–º"
echo -e "   ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 30 —Å–µ–∫—É–Ω–¥"
echo -e "   üìù –õ–æ–≥–∏: ${LOG_FILE}"
echo ""

echo -e "${GREEN}üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê...${NC}"
echo -e "${YELLOW}üí° –¢–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥${NC}"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –≤ —Ñ–æ–Ω–µ
npx ts-node night_test_runner.ts 0.0083 2>&1 | tee "$LOG_FILE" &
TEST_PID=$!

# –ñ–¥–µ–º 30 —Å–µ–∫—É–Ω–¥
sleep 30

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
echo ""
echo -e "${YELLOW}‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç...${NC}"
kill -TERM $TEST_PID 2>/dev/null
wait $TEST_PID 2>/dev/null

echo ""
echo -e "${BLUE}==============================${NC}"
echo -e "${GREEN}‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù${NC}"

# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
echo ""
echo -e "${PURPLE}üìä –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞
ACTIVITY_COUNT=$(grep -c "‚ö° \[" "$LOG_FILE" 2>/dev/null || echo "0")
NETWORK_ISSUES=$(grep -c "üåê\|üîÑ –ü–æ–ø—ã—Ç–∫–∞\|–í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è" "$LOG_FILE" 2>/dev/null || echo "0")
CRITICAL_ERRORS=$(grep -c "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞\|üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞" "$LOG_FILE" 2>/dev/null || echo "0")
RECOVERED=$(grep -c "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ" "$LOG_FILE" 2>/dev/null || echo "0")

echo -e "   üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ—Ç–∞: ${ACTIVITY_COUNT} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"
echo -e "   üåê –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: ${NETWORK_ISSUES}"
echo -e "   ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${RECOVERED}"
echo -e "   ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏: ${CRITICAL_ERRORS}"

# –û—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
echo ""
if [ "$ACTIVITY_COUNT" -gt 2 ]; then
    echo -e "${GREEN}‚úÖ –ë–û–¢ –†–ê–ë–û–¢–ê–ï–¢: –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –ù–ò–ó–ö–ê–Ø –ê–ö–¢–ò–í–ù–û–°–¢–¨: –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã${NC}"
fi

if [ "$CRITICAL_ERRORS" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –û–®–ò–ë–ö–ò: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç${NC}"
else
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ò: ${CRITICAL_ERRORS} –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫${NC}"
fi

if [ "$NETWORK_ISSUES" -gt 0 ] && [ "$RECOVERED" -gt 0 ]; then
    echo -e "${GREEN}‚úÖ –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨: Retry-–º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç${NC}"
elif [ "$NETWORK_ISSUES" -eq 0 ]; then
    echo -e "${CYAN}‚ÑπÔ∏è –°–ï–¢–¨: –ü—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –£–°–¢–û–ô–ß–ò–í–û–°–¢–¨: –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º${NC}"
fi

# –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
echo ""
if [ "$CRITICAL_ERRORS" -eq 0 ] && [ "$ACTIVITY_COUNT" -gt 2 ]; then
    echo -e "${GREEN}üéâ –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: –û–¢–õ–ò–ß–ù–û${NC}"
    echo -e "   –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç"
    echo ""
    echo -e "${CYAN}üí° –ì–û–¢–û–í –ö –ù–û–ß–ù–û–ú–£ –¢–ï–°–¢–£:${NC}"
    echo -e "   ./start_night_test.sh 8"
elif [ "$CRITICAL_ERRORS" -eq 0 ]; then
    echo -e "${YELLOW}‚úÖ –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: –•–û–†–û–®–û${NC}"
    echo -e "   –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å"
else
    echo -e "${RED}‚ö†Ô∏è –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: –¢–†–ï–ë–£–ï–¢ –í–ù–ò–ú–ê–ù–ò–Ø${NC}"
    echo -e "   –ï—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏"
fi

echo ""
echo -e "${CYAN}üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏: ${LOG_FILE}${NC}"
echo -e "${YELLOW}üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: cat ${LOG_FILE}${NC}"

exit 0
